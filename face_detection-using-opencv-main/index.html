<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Face Detection</title>
    <style>
      :root {
        --primary: #6a5acd;
        --primary-dark: #5747c0;
        --bg: #f4f6fb;
        --text: #222;
        --muted: #666;
        --success: #2e7d32;
        --error: #c62828;
        --info: #1565c0;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue",
          Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 24px;
      }

      .card {
        width: 100%;
        max-width: 920px;
        background: #fff;
        border-radius: 16px;
        padding: 28px 28px 24px;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.25);
      }

      h1 {
        margin: 0 0 6px;
        text-align: center;
        color: var(--text);
        font-size: 28px;
        letter-spacing: 0.2px;
      }
      .subtitle {
        text-align: center;
        color: var(--muted);
        margin-bottom: 18px;
        font-size: 14px;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin: 16px 0 22px;
      }

      .btn {
        appearance: none;
        border: 0;
        border-radius: 999px;
        padding: 12px 22px;
        color: #fff;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        cursor: pointer;
        font-size: 14px;
        letter-spacing: 0.2px;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
        box-shadow: 0 8px 18px rgba(106, 90, 205, 0.35);
      }
      .btn:hover {
        transform: translateY(-1px);
      }
      .hiddenInput {
        display: none;
      }

      .status {
        display: none;
        text-align: center;
        margin: 8px 0;
        font-size: 14px;
      }
      .status.info {
        color: var(--info);
      }
      .status.success {
        color: var(--success);
      }
      .status.error {
        color: var(--error);
      }

      .meta {
        text-align: center;
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
      }

      .stage {
        display: none;
        margin-top: 18px;
        border: 1px solid #eee;
        border-radius: 10px;
        overflow: hidden;
        background: #000;
      }
      canvas {
        display: block;
        max-width: 100%;
        height: auto;
      }

      .loader {
        display: none;
        text-align: center;
        margin-top: 14px;
        color: var(--muted);
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Face Detection</h1>
      <div class="subtitle">
        Upload an image and I'll draw a green box around detected faces (runs on
        your local server).
      </div>

      <div class="controls">
        <label class="btn" for="fileInput">Choose image…</label>
        <input
          class="hiddenInput"
          id="fileInput"
          type="file"
          accept="image/*"
        />
      </div>

      <div id="status" class="status info">Ready</div>
      <div id="faceCount" class="meta" style="display: none"></div>
      <div id="loader" class="loader">Processing…</div>

      <div id="canvasContainer" class="stage">
        <canvas id="canvas"></canvas>
      </div>

      <div class="meta">
        Tip: If you see a connection error, start the Python server and reload
        this page.
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("fileInput");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const canvasContainer = document.getElementById("canvasContainer");
      const statusEl = document.getElementById("status");
      const loaderEl = document.getElementById("loader");
      const faceCountEl = document.getElementById("faceCount");

      function showStatus(msg, type = "info") {
        statusEl.textContent = msg;
        statusEl.className = `status ${type}`;
        statusEl.style.display = "block";
      }

      async function detectFacesOnServer(file) {
        const form = new FormData();
        form.append("image", file);
        // Tuned params to reduce false positives
        const params = new URLSearchParams({
          scale: "1.1",
          neighbors: "5",
          min: "30",
        });
        const res = await fetch(`/detect?${params.toString()}`, {
          method: "POST",
          body: form,
        });
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        return res.json();
      }

      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        showStatus("Processing image…", "info");
        loaderEl.style.display = "block";
        canvasContainer.style.display = "none";
        faceCountEl.style.display = "none";

        const img = new Image();
        img.onload = async () => {
          const w = img.naturalWidth || img.width;
          const h = img.naturalHeight || img.height;
          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);

          try {
            const result = await detectFacesOnServer(file);
            const faces = Array.isArray(result.faces) ? result.faces : [];

            if (faces.length > 0) {
              ctx.strokeStyle = "#00FF00";
              ctx.lineWidth = 3;
              ctx.font = "16px Arial";
              ctx.fillStyle = "#00FF00";

              faces.forEach((f, i) => {
                ctx.strokeRect(f.x, f.y, f.width, f.height);
                ctx.fillText(
                  `Face ${i + 1}`,
                  Math.max(0, f.x),
                  Math.max(12, f.y - 6)
                );
              });

              showStatus("✓ Face detection complete!", "success");
              faceCountEl.textContent = `Found ${faces.length} face${
                faces.length > 1 ? "s" : ""
              }`;
              faceCountEl.style.display = "block";
            } else {
              showStatus(
                "No faces detected. Try a clearer, front-facing photo.",
                "error"
              );
            }

            canvasContainer.style.display = "block";
          } catch (err) {
            console.error(err);
            showStatus(
              "Could not reach the local detector. Start the server (python server.py).",
              "error"
            );
          } finally {
            loaderEl.style.display = "none";
          }
        };
        img.onerror = () => {
          loaderEl.style.display = "none";
          showStatus("Could not load the image.", "error");
        };
        img.src = URL.createObjectURL(file);
      });
    </script>
  </body>
</html>
